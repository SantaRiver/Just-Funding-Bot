#!/bin/bash
# ะกะบัะธะฟั ะดะปั ะทะฐะฟััะบะฐ ะฑะพัะฐ ะฒ ัะพะฝะพะฒะพะผ ัะตะถะธะผะต (daemon)

echo "๐ ะะฐะฟััะบ Funding Bot ะฒ ัะพะฝะพะฒะพะผ ัะตะถะธะผะต..."

# ะัะพะฒะตััะตะผ ะฝะต ะทะฐะฟััะตะฝ ะปะธ ัะถะต ะฑะพั
if pgrep -f "bot.py" > /dev/null; then
    echo "โ๏ธ  ะะพั ัะถะต ะทะฐะฟััะตะฝ!"
    echo ""
    echo "๐ ะะฐะฟััะตะฝะฝัะต ะฟัะพัะตััั:"
    ps aux | grep '[b]ot.py'
    echo ""
    echo "ะัะฟะพะปัะทัะนัะต './stop_bot.sh' ะดะปั ะพััะฐะฝะพะฒะบะธ"
    exit 1
fi

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต .env ัะฐะนะปะฐ
if [ ! -f .env ]; then
    echo "โ ะคะฐะนะป .env ะฝะต ะฝะฐะนะดะตะฝ!"
    echo "ะกะบะพะฟะธััะนัะต .env.example ะฒ .env ะธ ะทะฐะฟะพะปะฝะธัะต ะฟะตัะตะผะตะฝะฝัะต"
    exit 1
fi

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั
if [ ! -d "venv" ]; then
    echo "โ๏ธ  ะะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต ะฝะต ะฝะฐะนะดะตะฝะพ"
    echo "ะกะพะทะดะฐั venv..."
    python3 -m venv venv
    source venv/bin/activate
    pip install -r requirements.txt
else
    source venv/bin/activate
fi

# ะกะพะทะดะฐะตะผ ะดะธัะตะบัะพัะธั ะดะปั ะปะพะณะพะฒ
mkdir -p logs

echo "โ ะะฐะฟััะบ ะฑะพัะฐ ะฒ ัะพะฝะพะฒะพะผ ัะตะถะธะผะต..."

# ะะฐะฟััะบะฐะตะผ ะฑะพัะฐ ะฒ ัะพะฝะต ั nohup
nohup python bot.py > logs/daemon.log 2>&1 &

# ะะพะปััะฐะตะผ PID
BOT_PID=$!

# ะะดะตะผ ัะตะบัะฝะดั ะธ ะฟัะพะฒะตััะตะผ ััะพ ะฟัะพัะตัั ะทะฐะฟัััะธะปัั
sleep 2

if ps -p $BOT_PID > /dev/null 2>&1; then
    echo "โ ะะพั ััะฟะตัะฝะพ ะทะฐะฟััะตะฝ!"
    echo "๐ PID: $BOT_PID"
    echo "๐ ะะพะณะธ: logs/bot.log"
    echo "๐ Daemon ะปะพะณ: logs/daemon.log"
    echo ""
    echo "ะะปั ะพััะฐะฝะพะฒะบะธ ะธัะฟะพะปัะทัะนัะต: ./stop_bot.sh"
    echo "ะะปั ะฟัะพัะผะพััะฐ ะปะพะณะพะฒ: tail -f logs/bot.log"
else
    echo "โ ะะต ัะดะฐะปะพัั ะทะฐะฟัััะธัั ะฑะพัะฐ"
    echo "๐ ะัะพะฒะตัััะต ะปะพะณะธ ะฒ logs/daemon.log"
    exit 1
fi
