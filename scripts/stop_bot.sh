#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±–æ—Ç–∞

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$(dirname "$0")/.." || exit 1

echo "üîç –ü–æ–∏—Å–∫ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±–æ—Ç–∞..."

# –ò—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –ø–æ —Ä–∞–∑–Ω—ã–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º
PIDS=$(ps aux | grep -E '[b]ot\.py|python.*bot\.py' | grep -v grep | awk '{print $2}')

if [ -z "$PIDS" ]; then
    echo "‚úÖ –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ pgrep
    PGREP_PIDS=$(pgrep -f "bot.py" 2>/dev/null)
    if [ ! -z "$PGREP_PIDS" ]; then
        echo "‚ö†Ô∏è  –ù–æ –Ω–∞–π–¥–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å—ã —á–µ—Ä–µ–∑ pgrep:"
        ps -p $PGREP_PIDS
        PIDS=$PGREP_PIDS
    else
        exit 0
    fi
fi

echo "üìã –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:"
ps aux | grep -E '[b]ot\.py|python.*bot\.py' | grep -v grep

echo ""
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."

for PID in $PIDS; do
    echo "  –£–±–∏–≤–∞—é –ø—Ä–æ—Ü–µ—Å—Å $PID"
    kill $PID 2>/dev/null
    sleep 1
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å
    if ps -p $PID > /dev/null 2>&1; then
        echo "  ‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å $PID –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è, –∏—Å–ø–æ–ª—å–∑—É—é kill -9"
        kill -9 $PID 2>/dev/null
    fi
done

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —É–±–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ pkill
echo "  üî® –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ pkill..."
pkill -9 -f "bot.py" 2>/dev/null
pkill -9 -f "python.*bot.py" 2>/dev/null

sleep 2

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
REMAINING=$(ps aux | grep '[b]ot.py' | wc -l)

if [ $REMAINING -eq 0 ]; then
    echo "‚úÖ –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    echo ""
    echo "üí° –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞:"
    echo "   scripts/fix_telegram_conflict.sh  # –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç"
    echo "   scripts/start_bot_daemon.sh       # –ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å"
else
    echo "‚ùå –û—Å—Ç–∞–ª–∏—Å—å –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:"
    ps aux | grep '[b]ot.py'
    echo ""
    echo "‚ö†Ô∏è  –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é:"
    echo "   pkill -9 -f bot.py"
fi
