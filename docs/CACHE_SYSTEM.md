# –°–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∏—Å—Ç–µ–º—É –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å TTL (Time To Live) –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç rate limiting –Ω–∞ API –±–∏—Ä–∂ –∏ —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. **TTL (Time To Live)**
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: **30 —Å–µ–∫—É–Ω–¥**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è TTL –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### 2. **Thundering Herd Protection**
–ó–∞—â–∏—Ç–∞ –æ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:
- –ï—Å–ª–∏ –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª –¥–∞–Ω–Ω—ã–µ ‚Üí –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ —ç—Ç–æ –≤—Ä–µ–º—è **–∂–¥—É—Ç** –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ –ø–æ–ª—É—á–∞—é—Ç —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞

### 3. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞**
- –ü–æ–ª–Ω–æ—Å—Ç—å—é async/await
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç asyncio.Lock –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏
- Thread-safe –¥–ª—è asyncio –æ–∫—Ä—É–∂–µ–Ω–∏—è

## üìä –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ö—ç—à –≤–∞–ª–∏–¥–µ–Ω
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1 -> /top -> –ö—ç—à (5 —Å–µ–∫) -> ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2 -> /top -> –ö—ç—à (5 —Å–µ–∫) -> ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 3 -> /top -> –ö—ç—à (5 —Å–µ–∫) -> ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: 0 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API –±–∏—Ä–∂!

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ö—ç—à –∏—Å—Ç–µ–∫, –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1 -> /top -> –ö—ç—à (35 —Å–µ–∫) -> ‚ùå –ò—Å—Ç–µ–∫
                                        -> üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ (3-5 —Å–µ–∫)
                                        -> ‚úÖ –ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: 1 —Ä–∞—É–Ω–¥ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API –±–∏—Ä–∂

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ö—ç—à –∏—Å—Ç–µ–∫, –º–Ω–æ–∂–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1 -> /top -> –ö—ç—à (35 —Å–µ–∫) -> ‚ùå –ò—Å—Ç–µ–∫ -> üîÑ –ù–∞—á–∞–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2 -> /top -> –ö—ç—à (35 —Å–µ–∫) -> ‚ùå –ò—Å—Ç–µ–∫ -> ‚è≥ –ñ–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 3 -> /top -> –ö—ç—à (35 —Å–µ–∫) -> ‚ùå –ò—Å—Ç–µ–∫ -> ‚è≥ –ñ–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

... —á–µ—Ä–µ–∑ 3-5 —Å–µ–∫—É–Ω–¥ ...

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1 -> ‚úÖ –ü–æ–ª—É—á–∏–ª –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2 -> ‚úÖ –ü–æ–ª—É—á–∏–ª –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ  
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 3 -> ‚úÖ –ü–æ–ª—É—á–∏–ª –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: 1 —Ä–∞—É–Ω–¥ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API –±–∏—Ä–∂ (–Ω–µ 3!)

## üõ†Ô∏è –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### `/cache_stats` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –∫—ç—à–µ
- –°–∫–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã—Ö / –∏—Å—Ç–µ–∫—à–∏—Ö
- –í–æ–∑—Ä–∞—Å—Ç –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
- TTL –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏

–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
```
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

üì¶ –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: 2
‚úÖ –í–∞–ª–∏–¥–Ω—ã—Ö: 1
‚ùå –ò—Å—Ç–µ–∫—à–∏—Ö: 1

–ó–∞–ø–∏—Å–∏ –≤ –∫—ç—à–µ:
‚úÖ grouped_by_token:5
   –í–æ–∑—Ä–∞—Å—Ç: 15.3—Å / TTL: 30—Å
‚ùå grouped_by_token:10
   –í–æ–∑—Ä–∞—Å—Ç: 45.7—Å / TTL: 30—Å
```

### `/clear_cache` - –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à

–ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ—Ç –∫—ç—à. –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å –≤—ã–∑–æ–≤–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–∏—Ä–∂
- –ü—Ä–∏ –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–∏ –Ω–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ
- –î–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ö–ª—é—á–∏ –∫—ç—à–∞

–ö—ç—à –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:

| –ö–æ–º–∞–Ω–¥–∞ | –ö–ª—é—á –∫—ç—à–∞ | TTL |
|---------|-----------|-----|
| `/top` | `grouped_by_token:5` | 30 —Å–µ–∫ |
| `/top` —Å limit=10 | `grouped_by_token:10` | 30 —Å–µ–∫ |

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–ï—Å–ª–∏ –≤–æ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:
1. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –æ—à–∏–±–∫–∞
2. –ï—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞—Ä—ã–π –∫—ç—à ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π –∫—ç—à
3. –ï—Å–ª–∏ –Ω–µ—Ç —Å—Ç–∞—Ä–æ–≥–æ –∫—ç—à–∞ ‚Üí –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –∏—Å–∫–ª—é—á–µ–Ω–∏–µ

### Cleanup

–ò—Å—Ç–µ–∫—à–∏–µ –∑–∞–ø–∏—Å–∏ —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –¥–æ—Å—Ç—É–ø–∞.

–ú–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å manual cleanup:
```python
await aggregator.cache.cleanup_expired()
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ TTL

### –ò–∑–º–µ–Ω–∏—Ç—å TTL –≥–ª–æ–±–∞–ª—å–Ω–æ

–í `bot.py`:
```python
def _init_aggregator(self) -> FundingRateAggregator:
    exchanges = [...]
    return FundingRateAggregator(exchanges, cache_ttl=60)  # 60 —Å–µ–∫—É–Ω–¥
```

### –ò–∑–º–µ–Ω–∏—Ç—å TTL –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

–í `aggregator.py`:
```python
return await self.cache.get_or_fetch(
    key=cache_key,
    fetch_func=lambda: self._fetch_grouped_by_token(top_contracts_limit),
    ttl=60  # –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å TTL –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
)
```

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ë–µ–∑ –∫—ç—à–∞ (–∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å = API call)
```
10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π √ó 5 –±–∏—Ä–∂ = 50 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
Rate limit Bybit: 120 req/min
Risk: ‚ùå –í—ã—Å–æ–∫–∏–π (41% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
```

### –° –∫—ç—à–µ–º (TTL 30 —Å–µ–∫)
```
10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚Üí 2 –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è/–º–∏–Ω—É—Ç—É √ó 5 –±–∏—Ä–∂ = 10 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
Rate limit Bybit: 120 req/min
Risk: ‚úÖ –ù–∏–∑–∫–∏–π (8% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
```

### –≠–∫–æ–Ω–æ–º–∏—è: 80% –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API! üéâ

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –í–∫–ª—é—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í `bot.py` –∏–ª–∏ `main.py`:
```python
logging.basicConfig(level=logging.DEBUG)
```

–í—ã —É–≤–∏–¥–∏—Ç–µ:
```
DEBUG - Cache HIT for 'grouped_by_token:5' (age: 10.3s)
INFO  - Cache MISS for 'grouped_by_token:5' - fetching data
INFO  - Cache WAIT for 'grouped_by_token:5' - update in progress
INFO  - Cache UPDATED for 'grouped_by_token:5' (TTL: 30s)
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫—ç—à–∞ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ

```python
stats = await aggregator.get_cache_stats()
print(stats)
```

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π TTL –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é

| –°—Ü–µ–Ω–∞—Ä–∏–π | –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π TTL | –ü–æ—á–µ–º—É |
|----------|-------------------|--------|
| –ú–∞–ª–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (<10) | 30-60 —Å–µ–∫ | –ë–∞–ª–∞–Ω—Å —Å–≤–µ–∂–µ—Å—Ç–∏ –∏ –Ω–∞–≥—Ä—É–∑–∫–∏ |
| –°—Ä–µ–¥–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (10-100) | 30 —Å–µ–∫ | –ó–∞—â–∏—Ç–∞ –æ—Ç burst requests |
| –ú–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (>100) | 60-120 —Å–µ–∫ | –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ |
| Dev/Testing | 10 —Å–µ–∫ | –ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π |

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ:
1. `/cache_stats` - —Å–∫–æ–ª—å–∫–æ hit/miss
2. –õ–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ rate limit –æ—à–∏–±–æ–∫
3. –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –±–æ—Ç–∞

### Best Practices

‚úÖ **DO:**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ TTL 30+ —Å–µ–∫—É–Ω–¥ –¥–ª—è production
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ cache hit rate
- –õ–æ–≥–∏—Ä—É–π—Ç–µ cache miss –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

‚ùå **DON'T:**
- –ù–µ —Å—Ç–∞–≤—å—Ç–µ TTL < 10 —Å–µ–∫—É–Ω–¥ (—Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤)
- –ù–µ –æ—á–∏—â–∞–π—Ç–µ –∫—ç—à –±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã
- –ù–µ –¥–µ–ª–∞–π—Ç–µ TTL > 5 –º–∏–Ω—É—Ç (–¥–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ—é—Ç)

## üöÄ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

1. **Redis backend** - –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –∫—ç—à–∞
2. **Warming cache** - –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
3. **Smart TTL** - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π TTL –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
4. **Partial invalidation** - –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø–æ —Ç–æ–∫–µ–Ω—É
5. **Cache size limits** - LRU eviction –¥–ª—è –±–æ–ª—å—à–∏—Ö –∫—ç—à–µ–π

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `services/cache.py` - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫—ç—à–∞
- `services/aggregator.py` - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞
- `bot.py` - –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—ç—à–µ–º
